using System;
using System.Drawing;
using System.Windows.Forms;

namespace WinFormsApp2
{
    public partial class Form1 : Form
    {
        private readonly Random _rng = new Random();

        private enum RPS { Rock = 0, Paper = 1, Scissors = 2 }

        public Form1()
        {
            InitializeComponent();
            // 初始畫面設定（使用 PictureBox 顯示手勢）
            // 如果 PictureBox 尚未有實際大小，使用預設大小生成圖片
            pbComputerHand.Image = EmojiToBitmap("👊", GetPictureBoxSize(pbComputerHand));
            pbPlayerHand.Image = EmojiToBitmap("✋", GetPictureBoxSize(pbPlayerHand));
            lblResult.Text = "請出拳";
        }

        private Size GetPictureBoxSize(PictureBox pb)
        {
            if (pb.ClientSize.Width > 0 && pb.ClientSize.Height > 0)
                return pb.ClientSize;
            // fallback size
            return new Size(200, 120);
        }

        private void btnRock_Click(object sender, EventArgs e)
        {
            Play(RPS.Rock);
        }

        private void btnPaper_Click(object sender, EventArgs e)
        {
            Play(RPS.Paper);
        }

        private void btnScissors_Click(object sender, EventArgs e)
        {
            Play(RPS.Scissors);
        }

        private void btnExit_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void Play(RPS player)
        {
            var computer = (RPS)_rng.Next(0, 3);
            // 對應 emoji 並畫到 PictureBox
            pbPlayerHand.Image = EmojiToBitmap(RpsToEmoji(player), GetPictureBoxSize(pbPlayerHand));
            pbComputerHand.Image = EmojiToBitmap(RpsToEmoji(computer), GetPictureBoxSize(pbComputerHand));

            // 判定: 0: rock,1:paper,2:scissors
            if (player == computer)
            {
                lblResult.Text = "平手";
                lblResult.ForeColor = Color.Black;
            }
            else if ((player == RPS.Rock && computer == RPS.Scissors)
                  || (player == RPS.Paper && computer == RPS.Rock)
                  || (player == RPS.Scissors && computer == RPS.Paper))
            {
                lblResult.Text = "玩家贏";
                lblResult.ForeColor = Color.Green;
            }
            else
            {
                lblResult.Text = "電腦贏";
                lblResult.ForeColor = Color.DarkRed;
            }
            // 可視化簡單提示：閃爍結果邊框
            FlashResultBorder();
        }

        private string RpsToEmoji(RPS r)
        {
            return r switch
            {
                RPS.Rock => "👊",
                RPS.Paper => "✋",
                RPS.Scissors => "✌️",
                _ => "❓"
            };
        }

        private Image EmojiToBitmap(string emoji, Size size)
        {
            if (size.Width <= 0 || size.Height <= 0)
                size = new Size(200, 120);

            var bmp = new Bitmap(size.Width, size.Height);
            using (var g = Graphics.FromImage(bmp))
            {
                g.Clear(SystemColors.Control);
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.AntiAliasGridFit;

                // Choose a font size that fits the box
                float fontSize = Math.Min(size.Height, size.Width) * 0.8f;
                using (var font = new Font("Segoe UI Emoji", fontSize, FontStyle.Regular, GraphicsUnit.Pixel))
                using (var brush = new SolidBrush(Color.Black))
                using (var sf = new StringFormat() { Alignment = StringAlignment.Center, LineAlignment = StringAlignment.Center })
                {
                    g.DrawString(emoji, font, brush, new RectangleF(0, 0, size.Width, size.Height), sf);
                }
            }
            return bmp;
        }

        private async void FlashResultBorder()
        {
            var original = lblResult.BorderStyle;
            lblResult.BorderStyle = BorderStyle.Fixed3D;
            await System.Threading.Tasks.Task.Delay(220);
            lblResult.BorderStyle = original;
        }

        private void lblPlayerHand_Click(object sender, EventArgs e)
        {

        }
    }
}
