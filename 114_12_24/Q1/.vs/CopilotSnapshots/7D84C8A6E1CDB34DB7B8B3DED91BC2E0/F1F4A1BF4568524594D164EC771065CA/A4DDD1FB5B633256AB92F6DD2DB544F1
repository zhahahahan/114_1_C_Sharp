using System;
using System.Drawing;
using System.IO;
using System.Windows.Forms;

namespace WinFormsApp2
{
    public partial class Form1 : Form
    {
        private readonly Random _rng = new Random();

        private enum RPS { Rock = 0, Paper = 1, Scissors = 2 }

        // win counters
        private int playerWins = 0;
        private int computerWins = 0;
        private int draws = 0;

        // last choices
        private RPS? lastPlayerChoice = null;
        private RPS? lastComputerChoice = null;

        public Form1()
        {
            InitializeComponent();

            // 初始畫面設定（使用 PictureBox 顯示手勢，從 Resources 載入）
            var cbSize = GetPictureBoxSize(pbComputerHand);
            var pbSize = GetPictureBoxSize(pbPlayerHand);

            // Use resource images if present, otherwise fallback to emoji bitmaps
            var resComputer = Properties.Resources.stone_computer as Image;
            var resPlayer = Properties.Resources.stone_player as Image;

            pbComputerHand.Image = (resComputer != null) ? ResizeImage(resComputer, cbSize) : EmojiToBitmap("👊", cbSize);
            pbPlayerHand.Image = (resPlayer != null) ? ResizeImage(resPlayer, pbSize) : EmojiToBitmap("✋", pbSize);

            lblResult.Text = "請出拳";
        }

        private Image ResizeImage(Image src, Size targetSize)
        {
            if (src == null) return null;
            if (targetSize.Width <= 0 || targetSize.Height <= 0)
                return new Bitmap(src);

            try
            {
                var bmp = new Bitmap(targetSize.Width, targetSize.Height);
                using (var g = Graphics.FromImage(bmp))
                {
                    g.Clear(Color.Transparent);
                    g.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBicubic;
                    g.DrawImage(src, new Rectangle(0, 0, bmp.Width, bmp.Height));
                }
                return bmp;
            }
            catch
            {
                return src;
            }
        }

        private Size GetPictureBoxSize(PictureBox pb)
        {
            if (pb.ClientSize.Width > 0 && pb.ClientSize.Height > 0)
                return pb.ClientSize;
            // fallback size
            return new Size(200, 120);
        }

        private void btnRock_Click(object sender, EventArgs e)
        {
            Play(RPS.Rock);
        }

        private void btnPaper_Click(object sender, EventArgs e)
        {
            Play(RPS.Paper);
        }

        private void btnScissors_Click(object sender, EventArgs e)
        {
            Play(RPS.Scissors);
        }

        private void btnExit_Click(object sender, EventArgs e)
        {
            // 顯示最終結果，使用者按 OK 後結束應用
            showFinalResult();
            // 關閉視窗
            this.Close();
        }

        private void Play(RPS player)
        {
            // store player's choice
            lastPlayerChoice = player;

            // get computer choice via helper
            var computer = getCompChoice();

            // show images
            showPlayerImage(player);
            showComputerImage(computer);

            // 判定並更新勝場計數（暫不顯示於介面）
            showWinner(player, computer);
        }

        // generate computer random choice and store to lastComputerChoice
        private RPS getCompChoice()
        {
            var choice = (RPS)_rng.Next(0, 3);
            lastComputerChoice = choice;
            return choice;
        }

        // show corresponding image for computer choice (from Resources)
        private void showComputerImage(RPS choice)
        {
            Image src = choice switch
            {
                RPS.Rock => Properties.Resources.stone_computer,
                RPS.Paper => Properties.Resources.paper_computer,
                RPS.Scissors => Properties.Resources.scissor_computer,
                _ => null
            };

            var img = src != null ? ResizeImage(src, GetPictureBoxSize(pbComputerHand)) : null;
            pbComputerHand.Image = img ?? EmojiToBitmap(RpsToEmoji(choice), GetPictureBoxSize(pbComputerHand));
        }

        // show corresponding image for player choice (from Resources)
        private void showPlayerImage(RPS choice)
        {
            Image src = choice switch
            {
                RPS.Rock => Properties.Resources.stone_player,
                RPS.Paper => Properties.Resources.paper_player,
                RPS.Scissors => Properties.Resources.scissor_player,
                _ => null
            };

            var img = src != null ? ResizeImage(src, GetPictureBoxSize(pbPlayerHand)) : null;
            pbPlayerHand.Image = img ?? EmojiToBitmap(RpsToEmoji(choice), GetPictureBoxSize(pbPlayerHand));
        }

        // compare choices, update counters but DO NOT display per-round result
        private void showWinner(RPS player, RPS computer)
        {
            if (player == computer)
            {
                draws++;
            }
            else if ((player == RPS.Rock && computer == RPS.Scissors)
                  || (player == RPS.Paper && computer == RPS.Rock)
                  || (player == RPS.Scissors && computer == RPS.Paper))
            {
                playerWins++;
            }
            else
            {
                computerWins++;
            }

            // 不在此顯示結果，改由結束遊戲時統一顯示
        }

        // show final aggregated result and update lblResult
        private void showFinalResult()
        {
            string overall;
            if (playerWins > computerWins) overall = "玩家總體勝利";
            else if (computerWins > playerWins) overall = "電腦總體勝利";
            else overall = "雙方平手";

            string message = $"最終結果:\r\n玩家: {playerWins}\r\n電腦: {computerWins}\r\n平手: {draws}\r\n\r\n{overall}";

            // 更新 lblResult 並高亮
            lblResult.Text = overall + $" — 玩家:{playerWins} 電腦:{computerWins} 平手:{draws}";
            lblResult.ForeColor = playerWins > computerWins ? Color.Green : (computerWins > playerWins ? Color.DarkRed : Color.Black);
            FlashResultBorder();

            // 顯示對話框讓使用者看到細節
            MessageBox.Show(message, "遊戲結果", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        private string RpsToEmoji(RPS r)
        {
            return r switch
            {
                RPS.Rock => "👊",
                RPS.Paper => "✋",
                RPS.Scissors => "✌️",
                _ => "❓"
            };
        }

        private Image EmojiToBitmap(string emoji, Size size)
        {
            if (size.Width <= 0 || size.Height <= 0)
                size = new Size(200, 120);

            var bmp = new Bitmap(size.Width, size.Height);
            using (var g = Graphics.FromImage(bmp))
            {
                g.Clear(SystemColors.Control);
                g.TextRenderingHint = System.Drawing.Text.TextRenderingHint.AntiAliasGridFit;

                // Choose a font size that fits the box
                float fontSize = Math.Min(size.Height, size.Width) * 0.8f;
                using (var font = new Font("Segoe UI Emoji", fontSize, FontStyle.Regular, GraphicsUnit.Pixel))
                using (var brush = new SolidBrush(Color.Black))
                using (var sf = new StringFormat() { Alignment = StringAlignment.Center, LineAlignment = StringAlignment.Center })
                {
                    g.DrawString(emoji, font, brush, new RectangleF(0, 0, size.Width, size.Height), sf);
                }
            }
            return bmp;
        }

        private async void FlashResultBorder()
        {
            var original = lblResult.BorderStyle;
            lblResult.BorderStyle = BorderStyle.Fixed3D;
            await System.Threading.Tasks.Task.Delay(220);
            lblResult.BorderStyle = original;
        }

        private void lblPlayerHand_Click(object sender, EventArgs e)
        {

        }
    }
}
